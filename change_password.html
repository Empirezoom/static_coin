<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Change Password ‚Äî ORYX</title>
    <link rel="icon" type="image/png" href="image/favicon.png" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      .animate-fade-in {
        animation: fadeIn 1s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow:
          0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      .input-focus:focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        border-color: rgb(99, 102, 241);
      }
      .password-strength {
        transition: all 0.3s ease;
      }
      .password-strength.weak {
        background-color: #ef4444;
        width: 33%;
      }
      .password-strength.medium {
        background-color: #f59e0b;
        width: 66%;
      }
      .password-strength.strong {
        background-color: #10b981;
        width: 100%;
      }
    </style>
  </head>
  <body
    class="bg-white font-semibold min-h-screen flex items-center justify-center p-6 animate-fade-in"
  >
    <div class="w-full max-w-lg">
      <!-- Header -->
      <div
        class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-2xl shadow-xl mb-8 text-center"
      >
        <div
          class="w-20 h-20 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4"
        >
          <span class="text-3xl">üîê</span>
        </div>
        <h1 class="text-3xl font-bold mb-2">Change Password</h1>
        <p class="text-indigo-100">Secure your account with a new password</p>
      </div>

      <!-- Main Form Card -->
      <div
        class="bg-white bg-opacity-90 backdrop-blur-sm rounded-xl shadow-lg card-hover p-8"
      >
        <form id="chgForm" class="space-y-6">
          <!-- Current Password -->
          <div>
            <label class="block text-sm font-semibold mb-2 flex items-center">
              <span class="mr-2 font-semibold">üîí</span>Current Password
            </label>
            <div class="relative">
              <input
                name="current"
                type="password"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent input-focus transition-all duration-200"
                placeholder="Enter your current password"
              />
              <button
                type="button"
                class="absolute right-3 top-3 font-semibold hover:text-gray-600 toggle-password"
                data-target="current"
              >
                <span class="text-lg">üëÅÔ∏è</span>
              </button>
            </div>
          </div>

          <!-- New Password -->
          <div>
            <label class="block text-sm font-semibold mb-2 flex items-center">
              <span class="mr-2 font-semibold">üÜï</span>New Password
            </label>
            <div class="relative">
              <input
                name="newpass"
                type="password"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent input-focus transition-all duration-200"
                placeholder="Enter your new password"
                minlength="8"
              />
              <button
                type="button"
                class="absolute right-3 top-3 font-semibold hover:text-gray-600 toggle-password"
                data-target="newpass"
              >
                <span class="text-lg">üëÅÔ∏è</span>
              </button>
            </div>
            <!-- Password Strength Indicator -->
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  id="passwordStrength"
                  class="password-strength h-2 rounded-full transition-all duration-300"
                ></div>
              </div>
              <p id="passwordFeedback" class="text-xs text-gray-600 mt-1">
                Password must be at least 8 characters
              </p>
            </div>
          </div>

          <!-- Confirm New Password -->
          <div>
            <label
              class="block text-sm font-semibold font-semibold mb-2 flex items-center"
            >
              <span class="mr-2">‚úÖ</span>Confirm New Password
            </label>
            <div class="relative">
              <input
                name="confirm"
                type="password"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent input-focus transition-all duration-200"
                placeholder="Confirm your new password"
              />
              <button
                type="button"
                class="absolute right-3 top-3 font-semibold hover:text-gray-600 toggle-password"
                data-target="confirm"
              >
                <span class="text-lg">üëÅÔ∏è</span>
              </button>
            </div>
            <div id="matchIndicator" class="mt-2 text-sm"></div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-4 pt-6">
            <button
              type="submit"
              class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 px-6 rounded-lg font-semibold hover:from-indigo-600 hover:to-purple-600 transition-all duration-300 shadow-lg flex items-center justify-center"
            >
              <span class="mr-2">üîÑ</span>Update Password
            </button>
            <a
              href="/profile.html"
              class="bg-gray-100 font-semibold py-3 px-6 rounded-lg font-semibold hover:bg-gray-200 transition-all duration-300 flex items-center justify-center"
            >
              <span class="mr-2">‚¨ÖÔ∏è</span>Back to Profile
            </a>
          </div>
        </form>

        <!-- Security Tips -->
        <div class="mt-8 bg-white p-4 rounded-lg border border-blue-200">
          <h4 class="text-sm font-semibold mb-2 flex items-center">
            <span class="mr-2 font-semibold">üõ°Ô∏è</span>Password Security Tips
          </h4>
          <ul class="text-xs font-semibold space-y-1">
            <li>‚Ä¢ Use at least 8 characters</li>
            <li>‚Ä¢ Include uppercase and lowercase letters</li>
            <li>‚Ä¢ Add numbers and special characters</li>
            <li>‚Ä¢ Avoid using personal information</li>
          </ul>
        </div>
      </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
      (function () {
        const form = document.getElementById("chgForm");

        // Password visibility toggle
        document.querySelectorAll(".toggle-password").forEach((button) => {
          button.addEventListener("click", function () {
            const targetId = this.getAttribute("data-target");
            const input = document.querySelector(`input[name="${targetId}"]`);
            const type =
              input.getAttribute("type") === "password" ? "text" : "password";
            input.setAttribute("type", type);
            this.innerHTML =
              type === "password"
                ? '<span class="text-lg">üëÅÔ∏è</span>'
                : '<span class="text-lg">üôà</span>';
          });
        });

        // Password strength checker
        function checkPasswordStrength(password) {
          let strength = 0;
          const feedback = [];

          if (password.length >= 8) strength++;
          else feedback.push("At least 8 characters");

          if (/[a-z]/.test(password)) strength++;
          else feedback.push("Lowercase letter");

          if (/[A-Z]/.test(password)) strength++;
          else feedback.push("Uppercase letter");

          if (/[0-9]/.test(password)) strength++;
          else feedback.push("Number");

          if (/[^A-Za-z0-9]/.test(password)) strength++;
          else feedback.push("Special character");

          return { strength, feedback };
        }

        // Real-time password validation
        const newPasswordInput = document.querySelector(
          'input[name="newpass"]',
        );
        const confirmInput = document.querySelector('input[name="confirm"]');
        const strengthBar = document.getElementById("passwordStrength");
        const feedbackText = document.getElementById("passwordFeedback");
        const matchIndicator = document.getElementById("matchIndicator");

        newPasswordInput.addEventListener("input", function () {
          const password = this.value;
          const { strength, feedback } = checkPasswordStrength(password);

          strengthBar.className =
            "password-strength h-2 rounded-full transition-all duration-300";

          if (password.length === 0) {
            strengthBar.style.width = "0%";
            feedbackText.textContent = "Password must be at least 8 characters";
            feedbackText.className = "text-xs text-gray-600 mt-1";
          } else if (strength < 3) {
            strengthBar.classList.add("weak");
            feedbackText.textContent = "Weak password: " + feedback.join(", ");
            feedbackText.className = "text-xs text-red-600 mt-1";
          } else if (strength < 4) {
            strengthBar.classList.add("medium");
            feedbackText.textContent =
              "Medium strength. Consider adding: " + feedback.join(", ");
            feedbackText.className = "text-xs text-yellow-600 mt-1";
          } else {
            strengthBar.classList.add("strong");
            feedbackText.textContent = "Strong password! ‚úÖ";
            feedbackText.className = "text-xs text-green-600 mt-1";
          }
        });

        confirmInput.addEventListener("input", function () {
          const newPass = newPasswordInput.value;
          const confirmPass = this.value;

          if (confirmPass === "") {
            matchIndicator.innerHTML = "";
          } else if (newPass === confirmPass) {
            matchIndicator.innerHTML =
              '<span class="text-green-600 flex items-center"><span class="mr-1">‚úÖ</span>Passwords match</span>';
          } else {
            matchIndicator.innerHTML =
              '<span class="text-red-600 flex items-center"><span class="mr-1">‚ùå</span>Passwords do not match</span>';
          }
        });

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const current = form.current.value.trim();
          const nw = form.newpass.value.trim();
          const conf = form.confirm.value.trim();

          // Enhanced validation
          if (!current) {
            showNotification("Please enter your current password", "error");
            return;
          }

          if (nw.length < 8) {
            showNotification(
              "New password must be at least 8 characters long",
              "error",
            );
            return;
          }

          if (nw !== conf) {
            showNotification("New passwords do not match", "error");
            return;
          }

          if (current === nw) {
            showNotification(
              "New password must be different from current password",
              "error",
            );
            return;
          }

          const user = ORYXAuth.currentUser ? ORYXAuth.currentUser() : null;
          if (!user) {
            showNotification("You must be logged in.", "error");
            setTimeout(() => (location.href = "/login.html"), 2000);
            return;
          }

          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<span class="mr-2">‚è≥</span>Updating...';
          submitBtn.disabled = true;

          const res = ORYXAuth.changePassword({
            oldPassword: current,
            newPassword: nw,
          });

          setTimeout(() => {
            if (res && res.ok) {
              showNotification(
                "Password updated successfully! A confirmation email was sent.",
                "success",
              );
              setTimeout(() => (location.href = "/profile.html"), 2000);
            } else {
              showNotification(
                "Error updating password: " +
                  (res && res.error ? res.error : "Unknown error"),
                "error",
              );
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
            }
          }, 1000); // Simulate processing time
        });

        function showNotification(message, type) {
          const notification = document.createElement("div");
          notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in ${
            type === "success" ? "bg-green-500" : "bg-red-500"
          } text-white`;
          notification.innerHTML = `<span class="mr-2">${type === "success" ? "‚úÖ" : "‚ùå"}</span>${message}`;
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 5000);
        }
      })();
    </script>
  </body>
</html>
